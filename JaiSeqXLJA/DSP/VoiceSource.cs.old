using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using SharpDX.XAudio2;
using SharpDX.Multimedia;
using SharpDX.XAPO.Fx;
using System.IO;

/** Drop-in replacement for BASSBUFF **/ 

namespace XAYRGA.SharpSL
{
    public class VoiceSource : IDisposable
    {

        private byte[] bufferData;
        private AudioBuffer sBuffer; 

        private bool isLooped;

        private int LoopStart;
        private int LoopEnd; 

        private float iPitch = 0;
        private float iVolume = 1;

        private WaveFormat fmt;
        private SourceVoice svoice;

        private SubmixVoice myMixer; 

        bool playing = false;

        public static VoiceSource[] AllSounds = new VoiceSource[8192];

        public VoiceSource(string file) 
        {
            int channels, bits_per_sample, sample_rate;
            bufferData = SharpSLEngine.LoadWavFromFile(file, out channels, out bits_per_sample, out sample_rate);

            fmt = new WaveFormat(sample_rate, bits_per_sample, channels);
            sBuffer = new AudioBuffer();
            sBuffer.AudioBytes = bufferData.Length;
            sBuffer.Stream = new SharpDX.DataStream(bufferData.Length, true, true);
            sBuffer.Stream.Write(bufferData, 0, bufferData.Length);
            sBuffer.PlayBegin = 0;
            sBuffer.PlayLength = 0;
            sBuffer.LoopCount = (isLooped ? 255:0);
            sBuffer.LoopBegin = LoopStart;
            sBuffer.LoopLength = LoopEnd - LoopStart;
            svoice = new SourceVoice(SharpSLEngine.GetEngineBase(), fmt, VoiceFlags.None, 1024f);
            myMixer = SharpSLEngine.GetDefaultMixer(); 
            svoice.SetOutputVoices(new VoiceSendDescriptor(myMixer));            
        }



        public VoiceSource(string file,bool loop,int ls, int le )
        {
            isLooped = loop;
            LoopStart = ls;
            LoopEnd = le;
            Console.WriteLine("{0} {1} {2} {3}", file, loop, ls, le);
            int channels, bits_per_sample, sample_rate;
            bufferData = SharpSLEngine.LoadWavFromFile(file, out channels, out bits_per_sample, out sample_rate);

            fmt = new WaveFormat(sample_rate, bits_per_sample, channels);
            sBuffer = new AudioBuffer();
            sBuffer.AudioBytes = bufferData.Length;
            sBuffer.Stream = new SharpDX.DataStream(bufferData.Length, true, true);
            sBuffer.Stream.Write(bufferData, 0, bufferData.Length);
            sBuffer.PlayBegin = 0;
            sBuffer.PlayLength = 0;
            
            sBuffer.LoopCount = (loop ? 255 : 0);
            //Console.WriteLine("==LoopStart== {0} -- {1}", LoopStart, bufferData.Length);
            sBuffer.LoopBegin = ls;
            sBuffer.LoopLength = le - ls; // fuck. 

            svoice = new SourceVoice(SharpSLEngine.GetEngineBase(), fmt, VoiceFlags.None, 1024f);

            myMixer = SharpSLEngine.GetDefaultMixer();
            svoice.SetOutputVoices(new VoiceSendDescriptor(myMixer));
        }

        public void Play()
        {
            playing = true;
            svoice.Start();
        }

        public void Stop()
        {
            playing = false;

            svoice.Stop();
        }

        public SoundEffectInstance CreateInstance()
        {
            return new SoundEffectInstance(sBuffer,fmt,myMixer);
        }

        public float Pitch
        {
            get
            {
                return iPitch;
            }
            set
            {
                svoice.SetFrequencyRatio(value);
                iPitch = value; 
            }
        }


        public float Volume
        {
            get
            {
                return iVolume;
            }
            set
            {
                svoice.SetVolume(value);
                iVolume = value; 
            }
        }

        public void Dispose()
        {

        }

        ~VoiceSource()
        {
            Dispose();
        }
    }
}
